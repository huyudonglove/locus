<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
.iframeDiv{
  position: relative;
  width: 100%;
  height: 100%;
}
.iframeDiv #webglId{
  display: inline-block;
  width: 800px;
  height: 600px;
  position: relative;
}
.iframeDiv #webglId2{
  display: inline-block;
  width: 800px;
  height: 600px;
  position: relative;
}
.iframeDiv .title{
  position: absolute;
  z-index: 50;
  left: 5px;
  top: 3px;
  color: #409EFF;
  font-size: 18px;
  font-weight: bold;
}
.iframeDiv .reset{
  position: absolute;
  z-index: 50;
  right: 15px;
  top: 3px;
  color: #409EFF;
  font-size: 18px;
  font-weight: bold;
}
.iframeDiv .cover {
  position: absolute;
  z-index: 100;
  background-color: rgba(0, 0, 0, 0.8);
  margin: 0;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  transition: opacity .3s;
}
.iframeDiv .loading {
  top: 50%;
  margin-top: -21px;
  width: 100%;
  text-align: center;
  position: absolute;
}
.iframeDiv .iconI {
  color: #409eff;
  font-size: 20px;
  animation: rotating 2s linear infinite;
}

.iframeDiv .loading .text {
  color: #409eff;
  margin: 3px 0;
  font-size: 14px;
  line-height: 20px;
}
  </style>
</head>
<body>
  <div class="iframeDiv">
    <div id="webglId">
      <div class="title">稀疏点云</div>
      <div id="cover1" class="cover">
        <div class="loading">
          <i class=" iconI el-icon-loading"></i>
          <p class="text">预览加载中...</p>
        </div>
      </div>
      <div id="reset1" class="reset">重置</div>
    </div>
    <div id="webglId2">
      <div class="title">稠密点云</div>
      <div id="cover2" class="cover">
        <div class="loading">
          <i class=" iconI el-icon-loading"></i>
          <p class="text">预览加载中...</p>
        </div>
      </div>
      <div id="reset2" class="reset">重置</div>
    </div>
  </div>
</body>
<script src="build/three.js"></script>
<script src="TrackballControls.js"></script>
<script src="PLYLoader.js"></script>
<script type="text/javascript">
var renderer,renderer2,scene,scene2,camera,camera2worker,worker2,controls,controls2,clock,clock2,delta,delta2
var data = window.location.search.slice(1).split('=')[1].split('+')
var sparseMapPath = data[0];
var denseMapPath = data[1];
document.getElementById('reset1').click = function(){
  controls.reset();
}
document.getElementById('reset2').click = function(){
  controls2.reset();
}
function initRender(){
       //创建渲染器
      renderer=new THREE.WebGLRenderer();
      renderer.setSize(800,600);
      renderer.setClearColor(0x000000, 1.0);
      renderer2=new THREE.WebGLRenderer();
      renderer2.setSize(800,600);
      renderer2.setClearColor(0x000000, 1.0);
      document.getElementById('webglId').appendChild(renderer.domElement);
      document.getElementById('webglId2').appendChild(renderer2.domElement);
    }
    function initScene(){
      //创造场景
      scene=new THREE.Scene();
      scene2=new THREE.Scene();
    }
    function initLight(){
      //添加灯光
      var light=new THREE.PointLight(0x000000);
      light.position.set(300,400,200);//光源的位置
      scene.add(light);//将光源加入到场景中
      scene.add(new THREE.AmbientLight(0x333333));
      //添加灯光
      var light2=new THREE.PointLight(0x000000);
      light2.position.set(300,400,200);//光源的位置
      scene2.add(light2);//将光源加入到场景中
      scene2.add(new THREE.AmbientLight(0x333333));
    }
    function initCamera(){
      //添加相机
      camera=new THREE.PerspectiveCamera(40,800/600,1,1000);
      camera.position.set(0, 0, 128);
      camera.lookAt(scene.position);
      //添加相机
      camera2=new THREE.PerspectiveCamera(40,800/600,1,1000);
      camera2.position.set(0, 0, 128);
      camera2.lookAt(scene2.position);
    }
    function initMesh(){
      //外部模型加载 没有材质的
      // worker = new Worker('file.worker.js');
      // worker.postMessage({
      //   path:window.location.protocol+'//'+window.location.host+`/static/${sparseMapPath}`
      // })
      // var a = new Date().getTime() / 1000
      // worker.onmessage = function(event) {
      //   console.log('model store success',JSON.parse(event.data));
      //   new THREE.ObjectLoader().parse(JSON.parse(event.data), function(e) {
      //     scene.add(e.children[0])
      //     worker.postMessage({
      //       stop:1
      //     })
      //     console.log(scene)
      //     console.log((new Date().getTime() / 1000) - a + " s")
      //   }, '.');
      // }
      // 构造线段
      var lineGeometry = new THREE.Geometry();
        lineGeometry.vertices.push(new THREE.Vector3(-20, -20, -20));
        lineGeometry.vertices.push(new THREE.Vector3(-20, 20, 20));
        lineGeometry.vertices.push(new THREE.Vector3(20, 20, 20));
        lineGeometry.vertices.push(new THREE.Vector3(20, -20, 20));
        lineGeometry.faces=[
          new THREE.Face4(0,1,2,3),
        ]
        lineGeometry.computeFaceNormals();
        var lineMaterial = new THREE.MeshLambertMaterial({
            color : 0x00ffff
        });
        var line = new THREE.Mesh(lineGeometry, lineMaterial);
        // 计算线条间的距离
        // line.computeLineDistances();
        scene.add(line);
        console.log(scene,'scene')
      var loader = new THREE.PLYLoader();
        loader.load(`/static/${sparseMapPath}`, function (geometry) {

          //更新顶点的法向量
          geometry.computeVertexNormals();
          // geometry.computeFaceNormals();
          geometry.computeBoundingBox();
          geometry.center();
          //创建纹理，并将模型添加到场景道中
          var material = new THREE.PointsMaterial( {size: 0.05,transparent: true,vertexColors:THREE.VertexColors,alphaTest: 0.5} );
          var mesh = new THREE.Points( geometry, material );

					mesh.castShadow = true;
          mesh.receiveShadow = true;
          self.maploading=false;
          scene.add( mesh );
        },function ( xhr ) {
          console.log( ( xhr.loaded / xhr.total * 100 ) + '% loaded' );
          self.loadedData = Math.floor(xhr.loaded/xhr.total*100)
        },function ( error ) {
          console.log( 'An error happened' );
      });
      var axes = new THREE.AxesHelper(100);
      scene.add(axes);

      // worker2 = new Worker('file.worker.js');
      // worker2.postMessage({
      //   path:window.location.protocol+'//'+window.location.host+`/static/${denseMapPath}`
      // })
      // var a2 = new Date().getTime() / 1000
      // worker2.onmessage = function(event) {
      //   console.log('model store success',JSON.parse(event.data));
      //   new THREE.ObjectLoader().parse(JSON.parse(event.data), function(e) {
      //     scene2.add(e.children[0])
      //     worker2.postMessage({
      //       stop:1
      //     })
      //     console.log(scene2)
      //     console.log((new Date().getTime() / 1000) - a2 + " s")
      //   }, '.');
      // }

      var loader2 = new THREE.PLYLoader();
        loader2.load(`/static/${denseMapPath}`, function (geometry) {

          //更新顶点的法向量
          geometry.computeVertexNormals();
          // geometry.computeFaceNormals();
          geometry.computeBoundingBox();
          geometry.center();
          //创建纹理，并将模型添加到场景道中
          var material = new THREE.PointsMaterial( {size: 0.05,transparent: true,vertexColors:THREE.VertexColors,alphaTest: 0.5} );
          var mesh = new THREE.Points( geometry, material );

					mesh.castShadow = true;
          mesh.receiveShadow = true;
          self.maploading2=false;
          scene2.add( mesh );
        },function ( xhr ) {
          console.log( ( xhr.loaded / xhr.total * 100 ) + '% loaded' );
        },function ( error ) {
          console.log( 'An error happened' );
      });
      var axes2 = new THREE.AxesHelper(100);
      scene2.add(axes2);
    }
    function initControls(){
      controls = new THREE.TrackballControls(camera, renderer.domElement);
      controls.rotateSpeed = 2.5;
      controls.zoomSpeed = 1.2;
      controls.panSpeed = 0.8;
      controls.noZoom = false;
      controls.noPan = false;
      controls.staticMoving = true;
      controls.dynamicDampingFactor = 0.3;
      clock = new THREE.Clock();
      controls2 = new THREE.TrackballControls(camera2, renderer2.domElement);
      controls2.rotateSpeed = 2.5;
      controls2.zoomSpeed = 1.2;
      controls2.panSpeed = 0.8;
      controls2.noZoom = false;
      controls2.noPan = false;
      controls2.staticMoving = true;
      controls2.dynamicDampingFactor = 0.3;
      clock2 = new THREE.Clock();
    }
    //渲染
    function render(){
      renderer.render(scene,camera);
      renderer2.render(scene2,camera2);
    }
    //动画执行
    function animate() {
      requestAnimationFrame(this.animate);
      render();
      delta = clock.getDelta();
      delta2 = clock2.getDelta();
      controls.update(delta);
      controls2.update(delta2);
    }
    /**
     * 清空当前obj对象的缓存object3D对象或mesh对象
     * */
    function clearCache(object) {
      let  mesh = object;
      mesh.geometry.dispose();
      mesh.material.dispose();
    }
    /**
     * 清空渲染器缓存，该demo中无需使用
     */
    function clearRenderer(){
      renderer.dispose();
      renderer.forceContextLoss();
      renderer.context = null;
      renderer.domElement = null;
      renderer = null;
      renderer2.dispose();
      renderer2.forceContextLoss();
      renderer2.context = null;
      renderer2.domElement = null;
      renderer2 = null;
    }
    initScene();
    initCamera();
    initMesh();
    initLight();
    initRender();
    initControls();
    animate();
</script>
</html>